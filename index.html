
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora Financiera PRO</title>
    <!-- Carga de Tailwind CSS para estilos -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; }
        .input-style {
            @apply w-full p-3 border border-gray-300 rounded-xl focus:ring-indigo-500 focus:border-indigo-500 transition duration-150;
        }
        .tab-button {
            /* Estilo base */
            @apply flex items-center justify-center space-x-2 py-3 px-4 mx-1 text-base sm:text-lg font-semibold text-gray-500 rounded-xl border-2 border-transparent hover:text-indigo-600 hover:border-indigo-300 transition duration-300 transform hover:scale-[1.02];
        }
        .tab-button.active {
            /* Estilo activo mejorado: Sombra, color más fuerte y borde inferior */
            @apply text-indigo-700 bg-white border-b-4 border-indigo-600 shadow-xl scale-100 ring-2 ring-indigo-300;
        }
        .content-section {
            display: none;
        }
        /* Clase para ocultar temporalmente la aplicación mientras carga la autenticación */
        .app-loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #fff;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
        }
    </style>
    
    <!-- LÓGICA DE FIREBASE (Módulo) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, onSnapshot, addDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        setLogLevel('Debug'); // Habilitar logs para depuración

        // Variables globales y configuración (OBLIGATORIO usar las variables del entorno)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth;
        window.currentUserId = null;
        window.currentUserEmail = "No autenticado";
        window.isAuthReady = false; // Bandera de estado de autenticación
        window.listenersStarted = false; // Bandera para asegurar que los listeners de Firestore solo se inician una vez
        window.allTransactions = []; // Almacenar transacciones para el Asesor IA

        // Inicialización de Firebase
        try {
            if (Object.keys(firebaseConfig).length > 0) {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                console.log("Firebase inicializado correctamente.");
            } else {
                console.error("Firebase config is missing or empty. La aplicación no usará almacenamiento persistente.");
            }
        } catch (e) {
            console.error("Error al inicializar Firebase:", e);
        }

        // ----------------------------------------------------
        // FÁBRICAS DE RUTAS DE FIRESTORE
        // ----------------------------------------------------

        function getCollectionRef(collectionName) {
             // Verificamos que Firebase y Auth estén listos
             if (!window.isAuthReady || !window.currentUserId || !db) return null;
             // Ruta privada: /artifacts/{appId}/users/{userId}/{collectionName}
             const path = `artifacts/${appId}/users/${window.currentUserId}/${collectionName}`;
             return collection(db, path);
        }

        // ----------------------------------------------------
        // LÓGICA DE AUTENTICACIÓN Y CARGA DE DATOS
        // ----------------------------------------------------

        if (auth) { // Solo iniciamos el listener si auth se inicializó correctamente
            onAuthStateChanged(auth, async (user) => {
                const appOverlay = document.getElementById('app-loading-overlay');
                
                if (user) {
                    window.currentUserId = user.uid;
                    window.currentUserEmail = user.email || "Usuario Anónimo (Token)";
                    document.getElementById('user-email-display').textContent = window.currentUserEmail;
                    document.getElementById('auth-status').textContent = `Conectado.`;
                    document.getElementById('auth-modal').classList.add('hidden');
                    window.isAuthReady = true;
                    
                    // Corrección para evitar errores de permisos iniciales (race condition)
                    if (!window.listenersStarted) {
                        // Pequeño retardo para asegurar que el token de autenticación se propague
                        // correctamente a Firestore antes de intentar cargar los datos.
                        setTimeout(() => {
                            window.listenersStarted = true;
                            loadTransactions();
                            loadLoans();
                            appOverlay.classList.add('hidden');
                        }, 50); // 50ms de retraso
                    } else {
                        appOverlay.classList.add('hidden');
                    }
                    
                } else {
                    window.isAuthReady = false;
                    window.listenersStarted = false; // Resetear si la sesión se cierra
                    window.currentUserEmail = "No autenticado";
                    document.getElementById('user-email-display').textContent = "Inicie Sesión";
                    document.getElementById('auth-status').textContent = `Desconectado.`;
                    
                    // Si el token inicial existe, intentamos usarlo
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Error de autenticación inicial con token:", error);
                            // Si el token falla, mostramos el modal estándar para login/registro
                            document.getElementById('auth-modal').classList.remove('hidden');
                            appOverlay.classList.add('hidden');
                        }
                    } else {
                            // Mostrar modal de autenticación si no hay sesión ni token
                            document.getElementById('auth-modal').classList.remove('hidden');
                            appOverlay.classList.add('hidden');
                    }
                }
            });
        } else {
            // Si auth no está disponible
            document.getElementById('user-email-display').textContent = "Config. Inválida";
            document.getElementById('auth-status').textContent = `ERROR FATAL.`;
            document.getElementById('app-loading-overlay').classList.add('hidden');
        }

        // Manejo de Autenticación (Login/Registro)
        window.handleAuth = async function(e) {
            e.preventDefault();
            const form = e.target;
            const email = form.elements.auth_email.value;
            const password = form.elements.auth_password.value;
            const action = form.elements.auth_action.value; // 'login' or 'register'

            if (!email || !password) {
                return window.alertModal("Error", "Por favor, ingrese email y contraseña.");
            }
            if (!auth) {
                return window.alertModal("Error", "El servicio de autenticación no está disponible.");
            }

            try {
                if (action === 'register') {
                    await createUserWithEmailAndPassword(auth, email, password);
                    window.alertModal("Registro Exitoso", "¡Cuenta creada! Se ha iniciado sesión automáticamente.");
                } else {
                    await signInWithEmailAndPassword(auth, email, password);
                    window.alertModal("Inicio de Sesión Exitoso", "Bienvenido de nuevo.");
                }
                document.getElementById('auth-modal').classList.add('hidden');
            } catch (error) {
                console.error("Error de autenticación:", error.code, error.message);
                let userMessage = "Error de autenticación. Intente de nuevo.";
                if (error.code === 'auth/email-already-in-use') {
                    userMessage = "El email ya está en uso. Intente Iniciar Sesión.";
                } else if (error.code === 'auth/invalid-email' || error.code === 'auth/weak-password') {
                    userMessage = "Email o contraseña inválidos/débiles.";
                } else if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                     userMessage = "Credenciales inválidas para iniciar sesión.";
                }
                window.alertModal("Fallo de Autenticación", userMessage);
            }
        };

        window.handleLogout = async function() {
            if (auth && auth.currentUser) {
                try {
                    await signOut(auth);
                    window.alertModal("Sesión Cerrada", "Ha cerrado su sesión con éxito.");
                    document.getElementById('auth-modal').classList.remove('hidden');
                } catch (error) {
                    console.error("Error al cerrar sesión:", error);
                    window.alertModal("Error", "No se pudo cerrar la sesión.");
                }
            }
        };


        // ----------------------------------------------------
        // LÓGICA DE TRANSACCIONES (Ingresos/Gastos MULTIMONEDA)
        // ----------------------------------------------------

        window.saveTransaction = async function(name, amount, type, category, currency) {
            if (!window.isAuthReady) return window.alertModal("Error", "Debe iniciar sesión para guardar datos.");
            
            const transactionsColRef = getCollectionRef('transactions');
            if (!transactionsColRef) return window.alertModal("Error", "No se pudo acceder a la base de datos.");
            
            const transactionData = {
                name,
                amount: parseFloat(amount),
                type, // 'income' o 'expense'
                category,
                currency, // Nuevo campo de moneda
                timestamp: Date.now(),
            };

            try {
                await addDoc(transactionsColRef, transactionData);
                window.alertModal("Éxito", `${type === 'income' ? 'Ingreso' : 'Gasto'} en ${currency} guardado.`);
            } catch (e) {
                console.error("Error al guardar transacción: ", e);
                window.alertModal("Error", "No se pudo guardar la transacción.");
            }
        };

        function loadTransactions() {
            const transactionsColRef = getCollectionRef('transactions');
            if (!transactionsColRef) return;

            onSnapshot(transactionsColRef, (snapshot) => {
                const listEl = document.getElementById('transactions-list');
                listEl.innerHTML = '';
                let transactionArray = [];
                let currencySummary = {};

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    transactionArray.push(data);
                    
                    // Agrupar por moneda para el resumen
                    const key = `${data.currency}_${data.type}`;
                    if (!currencySummary[key]) {
                        currencySummary[key] = {
                            currency: data.currency,
                            type: data.type,
                            total: 0
                        };
                    }
                    currencySummary[key].total += data.amount;
                });
                
                window.allTransactions = transactionArray; // Almacenar para el AI

                transactionArray.sort((a, b) => b.timestamp - a.timestamp);

                // ------------------------------------------------------------------
                // 1. Renderizar Resumen del Dashboard (por Divisa)
                // ------------------------------------------------------------------
                const incomesEl = document.getElementById('total-incomes-summary');
                const expensesEl = document.getElementById('total-expenses-summary');
                incomesEl.innerHTML = '';
                expensesEl.innerHTML = '';
                
                let hasData = false;
                
                Object.values(currencySummary).forEach(summary => {
                    hasData = true;
                    // Usamos un locale que funcione bien con múltiples monedas para el formato
                    const formattedAmount = new Intl.NumberFormat('es-MX', {
                        style: 'currency',
                        currency: summary.currency,
                        minimumFractionDigits: 2
                    }).format(summary.total);

                    const summaryItem = `<span class="inline-block px-3 py-1 bg-white border rounded-full text-sm font-semibold shadow-sm">${formattedAmount} (${summary.currency})</span>`;
                    
                    if (summary.type === 'income') {
                        incomesEl.innerHTML += summaryItem;
                    } else if (summary.type === 'expense') {
                        expensesEl.innerHTML += summaryItem;
                    }
                });
                
                if (!hasData) {
                    incomesEl.innerHTML = '<span class="text-sm text-gray-500">Sin registros de ingresos.</span>';
                    expensesEl.innerHTML = '<span class="text-sm text-gray-500">Sin registros de gastos.</span>';
                }

                // ------------------------------------------------------------------
                // 2. Renderizar Lista de Transacciones Recientes
                // ------------------------------------------------------------------
                if (transactionArray.length === 0) {
                     listEl.innerHTML = '<li class="p-2 text-center text-gray-500 text-sm">No hay transacciones registradas.</li>';
                } else {
                    transactionArray.forEach(data => {
                        const typeClass = data.type === 'income' ? 'text-green-600' : 'text-red-600';
                        const sign = data.type === 'income' ? '+' : '-';
                        const date = new Date(data.timestamp).toLocaleDateString();
                        
                        // Formatear la cantidad específica para su moneda
                        const formattedAmount = new Intl.NumberFormat('es-MX', {
                            style: 'currency',
                            currency: data.currency,
                            minimumFractionDigits: 2
                        }).format(data.amount);
                        
                        const listItem = `
                            <li class="flex justify-between items-center p-2 border-b last:border-b-0 hover:bg-gray-50 transition">
                                <div>
                                    <p class="font-medium text-gray-800">${data.name} <span class="text-xs text-gray-500">(${data.category})</span></p>
                                    <p class="text-xs text-gray-400">${date}</p>
                                </div>
                                <div class="flex items-center">
                                    <span class="font-bold ${typeClass}">${sign}${formattedAmount} <span class="text-xs font-normal text-gray-500">(${data.currency})</span></span>
                                    <button onclick="deleteDocById('transactions', '${data.id}')" class="ml-2 p-1 rounded-full text-red-400 hover:text-red-600 hover:bg-red-100 transition duration-150">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>
                                    </button>
                                </div>
                            </li>
                        `;
                        listEl.innerHTML += listItem;
                    });
                }
                
                // Actualizar Dashboard (Flujo Neto y Chart) con mensaje indicativo
                document.getElementById('net-flow-summary').innerHTML = `<p class="text-sm font-medium text-indigo-700">El flujo neto requiere conversión a una moneda base.</p>`;
                document.getElementById('dashboard-chart').innerHTML = `<p class="text-center text-gray-500 py-4">El gráfico de proporciones no está disponible en modo Multimoneda sin una divisa base de referencia.</p>`;


            }, (error) => {
                console.error("Error al cargar transacciones: ", error);
            });
        }
        
        // ----------------------------------------------------
        // LÓGICA DE PRÉSTAMOS/CRÉDITOS
        // ----------------------------------------------------

        window.saveLoan = async function(data) {
            if (!window.isAuthReady) return window.alertModal("Error", "Debe iniciar sesión para guardar datos.");
            
            const loansColRef = getCollectionRef('loans');
            if (!loansColRef) return window.alertModal("Error", "No se pudo acceder a la base de datos.");
            
            try {
                await addDoc(loansColRef, data);
                window.alertModal("Éxito", `Préstamo "${data.name}" guardado.`);
            } catch (e) {
                console.error("Error al guardar préstamo: ", e);
                window.alertModal("Error", "No se pudo guardar el préstamo.");
            }
        };

        function loadLoans() {
            const loansColRef = getCollectionRef('loans');
            if (!loansColRef) return;

            onSnapshot(loansColRef, (snapshot) => {
                const listEl = document.getElementById('loans-list');
                listEl.innerHTML = '';
                
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    data.id = doc.id;
                    
                    const remainingBalance = data.totalAmount - data.paidAmount;
                    const paymentsRemaining = data.totalPayments - data.paymentsMade;
                    const statusColor = remainingBalance > 0 ? 'text-red-600' : 'text-green-600';
                    const paymentsColor = paymentsRemaining > 0 ? 'text-gray-600' : 'text-green-600';

                    // Formatear cantidades asumiendo USD (se podría añadir el campo currency a Loans también si es necesario)
                    const formatAmount = (amount) => new Intl.NumberFormat('es-MX', { style: 'currency', currency: 'USD', minimumFractionDigits: 2 }).format(amount);

                    const listItem = `
                        <div class="p-4 bg-white border border-gray-200 rounded-lg shadow-sm mb-3 flex justify-between items-center hover:shadow-md transition duration-200">
                            <div>
                                <p class="text-lg font-semibold text-gray-800">${data.name}</p>
                                <p class="text-sm text-gray-500">Monto Original: ${formatAmount(data.totalAmount)} | Pagado: ${formatAmount(data.paidAmount)}</p>
                                <p class="text-xs text-gray-400">Pago mensual est.: ${formatAmount(data.paymentAmount)}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xl font-bold ${statusColor}">Saldo Pendiente: ${formatAmount(remainingBalance)}</p>
                                <p class="text-sm ${paymentsColor}">Pagos restantes: ${paymentsRemaining}</p>
                            </div>
                            <button onclick="deleteDocById('loans', '${data.id}')" class="ml-4 p-2 rounded-full text-red-400 hover:text-red-600 hover:bg-red-100 transition duration-150">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 10-2 0v6a1 1 0 102 0V8z" clip-rule="evenodd"/></svg>
                            </button>
                        </div>
                    `;
                    listEl.innerHTML += listItem;
                });

                if (snapshot.empty) {
                    listEl.innerHTML = '<p class="text-center text-gray-500 p-6">No hay préstamos registrados.</p>';
                }
            }, (error) => {
                console.error("Error al cargar préstamos: ", error);
            });
        }
        
        // Función general para eliminar documentos
        window.deleteDocById = async function(collectionName, docId) {
            if (!window.isAuthReady) return window.alertModal("Error", "Debe iniciar sesión para eliminar datos.");
            
            const colRef = getCollectionRef(collectionName);
            if (!colRef) return window.alertModal("Error", "No se pudo acceder a la base de datos.");
            
            try {
                await deleteDoc(doc(colRef, docId));
                window.alertModal("Eliminado", "Documento eliminado con éxito.");
            } catch (e) {
                console.error("Error al eliminar documento: ", e);
                window.alertModal("Error", "No se pudo eliminar el documento.");
            }
        }
        
    </script>
    
    <!-- LÓGICA DEL SCRIPT PRINCIPAL (Módulo) -->
    <script type="module">
        // Se asegura de que las variables globales estén accesibles
        if (typeof window.isAuthReady === 'undefined') {
            window.isAuthReady = false;
        }
        
        // Lista de divisas para el selector
        const CURRENCIES = ['USD', 'EUR', 'GBP', 'JPY', 'MXN', 'COP', 'ARS', 'CLP', 'GTQ'];
        
        // ----------------------------------------------------
        // LÓGICA DE UI Y CONTROL DE TABS
        // ----------------------------------------------------
        window.currentTab = 'dashboard';
        
        document.addEventListener('DOMContentLoaded', () => {
             // Inicializar la vista
             window.showTab(window.currentTab);
             
             // Llenar el selector de divisas
             const currencySelect = document.getElementById('currency-select');
             currencySelect.innerHTML = CURRENCIES.map(c => `<option value="${c}">${c}</option>`).join('');

             // Setup Event Listeners
             document.getElementById('auth-form').addEventListener('submit', window.handleAuth); 
             document.getElementById('transaction-form').addEventListener('submit', handleTransactionSubmit);
             document.getElementById('loan-form').addEventListener('submit', handleLoanSubmit);
             document.getElementById('interest-form').addEventListener('submit', handleInterestSubmit);
             document.getElementById('ai-form').addEventListener('submit', handleAiSubmit);
             
             // Setup Alert Modal Close Button
             document.getElementById('alert-close-btn').addEventListener('click', () => {
                const modal = document.getElementById('alert-modal');
                modal.classList.remove('opacity-100', 'pointer-events-auto');
                modal.classList.add('opacity-0', 'pointer-events-none');
            });


        });

        window.showTab = function(tabName) {
            window.currentTab = tabName;
            
            // Ocultar todas las secciones
            document.querySelectorAll('.content-section').forEach(section => {
                section.style.display = 'none';
            });

            // Desactivar todos los botones
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });

            // Mostrar la sección y activar el botón
            document.getElementById(`${tabName}-section`).style.display = 'block';
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        // ----------------------------------------------------
        // LÓGICA DE FORMULARIOS Y CÁLCULOS
        // ----------------------------------------------------
        
        function handleTransactionSubmit(e) {
            e.preventDefault();
            if (!window.isAuthReady) return window.alertModal("Error", "Debe iniciar sesión para guardar datos.");
            
            const form = e.target;
            const type = form.elements.transaction_type.value;
            const name = form.elements.name.value;
            const amount = form.elements.amount.value;
            const category = form.elements.category.value;
            const currency = form.elements.currency.value; // Obtener la divisa
            
            if (name && parseFloat(amount) > 0) {
                // Se pasa la divisa a la función de guardado
                window.saveTransaction(name, amount, type, category, currency);
                form.reset();
                form.elements.transaction_type.value = 'expense'; 
                form.elements.currency.value = 'USD';
            } else {
                window.alertModal("Error", "Por favor, complete todos los campos y asegúrese de que el monto sea positivo.");
            }
        }
        
        function handleLoanSubmit(e) {
            e.preventDefault();
            if (!window.isAuthReady) return window.alertModal("Error", "Debe iniciar sesión para guardar datos.");

            const form = e.target;
            const totalAmount = parseFloat(form.elements.loan_total_amount.value);
            const paidAmount = parseFloat(form.elements.loan_paid_amount.value);
            const totalPayments = parseInt(form.elements.loan_total_payments.value);
            const paymentsMade = parseInt(form.elements.loan_payments_made.value);
            const paymentAmount = parseFloat(form.elements.loan_payment_amount.value);
            const name = form.elements.loan_name.value;

            if (totalAmount > 0 && totalPayments > 0 && paidAmount >= 0 && paymentsMade >= 0 && name && paymentAmount > 0) {
                if (paidAmount > totalAmount || paymentsMade > totalPayments) {
                     window.alertModal("Advertencia", "Los valores de pago/pagos realizados superan el total, pero se guardarán.");
                }
                
                const loanData = {
                    name,
                    totalAmount,
                    paidAmount,
                    totalPayments,
                    paymentsMade,
                    paymentAmount,
                    // Se podría añadir la divisa aquí también si fuera necesario
                    timestamp: Date.now(),
                };
                
                window.saveLoan(loanData);
                form.reset();
            } else {
                window.alertModal("Error", "Por favor, asegúrese de que todos los campos de monto y pagos sean válidos y positivos.");
            }
        }
        
        let lastCalculation = null; 

        function handleInterestSubmit(e) {
            e.preventDefault();
            const P = parseFloat(document.getElementById('principal').value);
            const r = parseFloat(document.getElementById('rate').value) / 100;
            const t = parseInt(document.getElementById('time').value);
            const n = parseInt(document.getElementById('compounds').value);
            
            if (isNaN(P) || isNaN(r) || isNaN(t) || isNaN(n) || P <= 0) {
                window.alertModal("Error de Entrada", "Por favor, introduzca valores válidos y positivos para el cálculo.");
                return;
            }

            const futureValue = P * Math.pow((1 + r / n), (n * t));
            const interestEarned = futureValue - P;

            document.getElementById('future-value-display').textContent = `$${futureValue.toFixed(2)}`;
            document.getElementById('interest-earned-display').textContent = `$${interestEarned.toFixed(2)}`;
            document.getElementById('interest-results-card').classList.remove('hidden');

            lastCalculation = {
                result: futureValue,
                inputs: { principal: P, rate: r * 100, time: t, compounds: n }
            };
        }
        
        window.saveCurrentCalculation = function() {
            if (lastCalculation) {
                window.alertModal("Función Deshabilitada", "La función de guardar la inversión de Interés Compuesto está deshabilitada en esta versión.");
            } else {
                window.alertModal("Error de Guardado", "Primero debe realizar un cálculo para poder guardarlo.");
            }
        }
        
        // ----------------------------------------------------
        // LÓGICA DEL ASESOR IA (GEMINI API)
        // ----------------------------------------------------

        async function handleAiSubmit(e) {
            e.preventDefault();
            if (!window.isAuthReady) {
                 window.alertModal("Acceso Denegado", "Debe iniciar sesión para usar el Asesor IA.");
                 return;
            }
            const prompt = document.getElementById('ai-prompt').value;
            if (!prompt) {
                window.alertModal("Error", "Por favor, escriba su consulta financiera.");
                return;
            }
            
            const aiOutput = document.getElementById('ai-output');
            const aiButton = document.getElementById('ai-submit-button');
            const aiLoader = document.getElementById('ai-loader');

            aiOutput.innerHTML = '';
            aiButton.disabled = true;
            aiButton.textContent = 'Generando recomendación...';
            aiLoader.classList.remove('hidden');

            const systemPrompt = `Actúa como un asesor financiero personal experto y amigable. Tu objetivo es proporcionar una recomendación concisa y accionable. Analiza la situación financiera del usuario y responde a su consulta. El usuario está usando un sistema multimoneda. Sé profesional y utiliza español formal.`;
            
            // Obtener el resumen de transacciones multimoneda para el contexto
            const summary = window.allTransactions.reduce((acc, t) => {
                const type = t.type === 'income' ? 'Ingreso' : 'Gasto';
                const key = `${type} (${t.currency})`;
                // Usar parseFloat para asegurar que la suma es correcta
                acc[key] = (acc[key] || 0) + parseFloat(t.amount); 
                return acc;
            }, {});
            
            const financialData = window.allTransactions.length > 0 ? 
                `Transacciones registradas (Multimoneda): ${JSON.stringify(summary)}. Usa esta información indicando las monedas. No intentes sumar montos de diferentes monedas.` 
                : "No se encontró información de Ingresos/Gastos. Responde basándote solo en la consulta del usuario.";

            const userQuery = `Consulta del Usuario: "${prompt}". Contexto de Datos Multimoneda: ${financialData}`;

            const apiKey = ""; 
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                tools: [{ "google_search": {} }],
                systemInstruction: {
                    parts: [{ text: systemPrompt }]
                },
            };

            const maxRetries = 3;
            let retryCount = 0;
            
            const fetchWithRetry = async () => {
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        if (response.status === 429 && retryCount < maxRetries) {
                            retryCount++;
                            const delay = Math.pow(2, retryCount) * 1000;
                            await new Promise(resolve => setTimeout(resolve, delay));
                            return fetchWithRetry();
                        }
                        throw new Error(`Error HTTP: ${response.status}`);
                    }

                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        let text = candidate.content.parts[0].text;
                        let sources = [];
                        const groundingMetadata = candidate.groundingMetadata;

                        if (groundingMetadata && groundingMetadata.groundingAttributions) {
                            sources = groundingMetadata.groundingAttributions
                                .map(attribution => ({
                                    uri: attribution.web?.uri,
                                    title: attribution.web?.title,
                                }))
                                .filter(source => source.uri && source.title); // Ensure sources are valid
                        }

                        // Formatear el texto y las fuentes para la visualización
                        let formattedOutput = text.replace(/\n/g, '<br>');

                        if (sources.length > 0) {
                            formattedOutput += '<div class="mt-4 pt-2 border-t border-gray-100 text-xs text-gray-500">';
                            formattedOutput += '<p class="font-semibold mb-1">Fuentes de consulta:</p>';
                            formattedOutput += sources.map((s, index) => 
                                `<a href="${s.uri}" target="_blank" class="block truncate hover:text-indigo-600 transition" title="${s.title}">[${index + 1}] ${s.title}</a>`
                            ).join('');
                            formattedOutput += '</div>';
                        }

                        aiOutput.innerHTML = formattedOutput;

                    } else {
                        aiOutput.innerHTML = '<p class="text-red-500">Error: No se pudo obtener una respuesta válida del Asesor IA.</p>';
                    }

                } catch (error) {
                    console.error("Error al llamar a la API de Gemini:", error);
                    aiOutput.innerHTML = `<p class="text-red-500">Error en la conexión o la API: ${error.message}</p>`;
                } finally {
                    aiButton.disabled = false;
                    aiButton.textContent = 'Obtener Recomendación';
                    aiLoader.classList.add('hidden');
                }
            };
            
            fetchWithRetry();
            document.getElementById('ai-prompt').value = ''; // Limpiar el prompt después de enviar
        }
        
        // ----------------------------------------------------
        // LÓGICA DE MODALES (Reemplazo de alert/confirm)
        // ----------------------------------------------------
        window.alertModal = function(title, message) {
            const modal = document.getElementById('alert-modal');
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            modal.classList.remove('opacity-0', 'pointer-events-none');
            modal.classList.add('opacity-100', 'pointer-events-auto');
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col">

    <!-- OVERLAY DE CARGA DE AUTENTICACIÓN -->
    <div id="app-loading-overlay" class="app-loading-overlay">
        <div class="flex flex-col items-center">
            <svg class="animate-spin -ml-1 mr-3 h-10 w-10 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-gray-600 font-semibold">Cargando aplicación y autenticación...</p>
        </div>
    </div>

    <!-- CONTENEDOR PRINCIPAL DE LA APLICACIÓN -->
    <div id="app-main" class="flex-grow p-4 sm:p-6 md:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- HEADER Y ESTATUS DE USUARIO -->
            <div class="flex justify-between items-center mb-6 p-4 bg-white rounded-xl shadow-lg">
                <h1 class="text-3xl font-extrabold text-indigo-800">Finanzas PRO <span class="text-sm text-gray-500 font-normal ml-2 hidden sm:inline">Calculadora & Asesor IA</span></h1>
                <div class="text-right text-sm">
                    <p id="user-email-display" class="font-bold text-gray-800">Cargando...</p>
                    <p id="auth-status" class="text-xs text-indigo-500">Esperando autenticación...</p>
                    <button onclick="window.handleLogout()" class="mt-1 text-xs text-red-500 hover:text-red-700 transition duration-150">Cerrar Sesión</button>
                </div>
            </div>

            <!-- NAVEGACIÓN DE PESTAÑAS (TABS) -->
            <nav class="flex justify-start space-x-1 sm:space-x-2 border-b border-gray-200 mb-6 bg-white p-2 rounded-xl shadow-md overflow-x-auto">
                <button id="tab-dashboard" class="tab-button active" onclick="showTab('dashboard')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 8v8m-4-6v6m-4-4v4m6-10H6a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V6a2 2 0 00-2-2z" /></svg>
                    <span>Dashboard</span>
                </button>
                <button id="tab-transactions" class="tab-button" onclick="showTab('transactions')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.115 0 2.223.364 3.093 1.093M12 8V6m0 8v2m8-4a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    <span>Transacciones</span>
                </button>
                <button id="tab-loans" class="tab-button" onclick="showTab('loans')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.495 9.479 5 8 5c-4.418 0-8 2.239-8 5s3.582 5 8 5c1.479 0 2.832-.495 4-1.253M12 6.253c1.168.758 2.521 1.253 4 1.253 4.418 0 8-2.239 8-5s-3.582-5-8-5c-1.479 0-2.832.495-4 1.253" /></svg>
                    <span>Préstamos</span>
                </button>
                <button id="tab-interest" class="tab-button" onclick="showTab('interest')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243m10.606-10.607l-4.242 4.243m0 0l-4.243-4.243m4.243 4.243V3" /></svg>
                    <span>Interés Compuesto</span>
                </button>
                <button id="tab-ai" class="tab-button" onclick="showTab('ai')">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.75 17L9 20l-1 1h8l-1-1v-3.25m-7.25 0h14.5c.345 0 .625-.28.625-.625v-8.75a.625.625 0 00-.625-.625H4.25c-.345 0-.625.28-.625.625v8.75c0 .345.28.625.625.625z" /></svg>
                    <span>Asesor IA</span>
                </button>
            </nav>

            <!-- ---------------------------------------------------------------------- -->
            <!-- SECCIÓN 1: DASHBOARD (PANEL PRINCIPAL) -->
            <!-- ---------------------------------------------------------------------- -->
            <section id="dashboard-section" class="content-section bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Resumen Financiero Multimoneda</h2>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <!-- Tarjeta de Ingresos -->
                    <div class="bg-green-50 p-5 rounded-xl border border-green-200 shadow-lg">
                        <p class="text-sm font-medium text-green-700">Total Ingresos por Divisa</p>
                        <div id="total-incomes-summary" class="mt-2 flex flex-wrap gap-2 text-xl font-extrabold text-green-900">
                            <!-- Datos de Ingresos por Divisa -->
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Gastos -->
                    <div class="bg-red-50 p-5 rounded-xl border border-red-200 shadow-lg">
                        <p class="text-sm font-medium text-red-700">Total Gastos por Divisa</p>
                        <div id="total-expenses-summary" class="mt-2 flex flex-wrap gap-2 text-xl font-extrabold text-red-900">
                            <!-- Datos de Gastos por Divisa -->
                        </div>
                    </div>
                    
                    <!-- Tarjeta de Flujo Neto -->
                    <div class="bg-indigo-50 p-5 rounded-xl border border-indigo-200 shadow-lg">
                        <p class="text-sm font-medium text-indigo-700">Flujo Neto Global</p>
                        <div id="net-flow-summary" class="mt-2 text-xl font-extrabold text-indigo-900">
                            <!-- Mensaje indicando la limitación de multimoneda -->
                        </div>
                    </div>
                </div>

                <!-- Gráfico (Placeholder para Multimoneda) -->
                <div class="bg-gray-100 p-6 rounded-xl mb-8 border border-gray-200">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Gráfico de Proporción (Ingresos vs. Gastos)</h3>
                    <div id="dashboard-chart" class="h-64 flex items-center justify-center">
                        <p class="text-center text-gray-500 py-4">El gráfico de proporciones no está disponible en modo Multimoneda sin una divisa base de referencia.</p>
                    </div>
                </div>

                <!-- Transacciones Recientes -->
                <div class="border-t pt-4">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Últimas Transacciones</h3>
                    <ul id="transactions-list" class="divide-y divide-gray-100 border rounded-lg overflow-hidden">
                        <!-- Transacciones cargadas por loadTransactions() -->
                    </ul>
                </div>
            </section>

            <!-- ---------------------------------------------------------------------- -->
            <!-- SECCIÓN 2: REGISTRO DE TRANSACCIONES (Ingreso/Gasto) -->
            <!-- ---------------------------------------------------------------------- -->
            <section id="transactions-section" class="content-section bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Registrar Transacción (Multimoneda)</h2>
                
                <form id="transaction-form" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    
                    <!-- Tipo de Transacción -->
                    <div>
                        <label for="transaction-type" class="block text-sm font-medium text-gray-700 mb-1">Tipo</label>
                        <select id="transaction-type" name="transaction_type" class="input-style bg-red-100 border-red-300">
                            <option value="expense">Gasto</option>
                            <option value="income">Ingreso</option>
                        </select>
                    </div>

                    <!-- Divisa (Nuevo) -->
                    <div>
                        <label for="currency-select" class="block text-sm font-medium text-gray-700 mb-1">Divisa</label>
                        <select id="currency-select" name="currency" class="input-style">
                            <!-- Opciones llenadas por JS -->
                        </select>
                    </div>

                    <!-- Nombre/Descripción -->
                    <div class="md:col-span-2">
                        <label for="transaction-name" class="block text-sm font-medium text-gray-700 mb-1">Descripción / Nombre</label>
                        <input type="text" id="transaction-name" name="name" class="input-style" placeholder="Ej: Pago de renta, Salario" required>
                    </div>
                    
                    <!-- Monto -->
                    <div>
                        <label for="transaction-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto ($)</label>
                        <input type="number" step="0.01" min="0.01" id="transaction-amount" name="amount" class="input-style" placeholder="100.00" required>
                    </div>

                    <!-- Categoría -->
                    <div>
                        <label for="transaction-category" class="block text-sm font-medium text-gray-700 mb-1">Categoría</label>
                        <select id="transaction-category" name="category" class="input-style">
                            <option value="Otros">Otros</option>
                            <option value="Alimentación">Alimentación</option>
                            <option value="Transporte">Transporte</option>
                            <option value="Vivienda">Vivienda</option>
                            <option value="Entretenimiento">Entretenimiento</option>
                            <option value="Salario">Salario</option>
                            <option value="Inversión">Inversión</option>
                        </select>
                    </div>
                    
                    <!-- Botón de Enviar -->
                    <div class="md:col-span-2 mt-4">
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-lg hover:shadow-xl transform hover:scale-[1.005]">
                            Guardar Transacción
                        </button>
                    </div>
                </form>
            </section>

            <!-- ---------------------------------------------------------------------- -->
            <!-- SECCIÓN 3: GESTIÓN DE PRÉSTAMOS -->
            <!-- ---------------------------------------------------------------------- -->
            <section id="loans-section" class="content-section bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Gestión de Préstamos y Deudas</h2>
                
                <!-- Formulario de Préstamo -->
                <form id="loan-form" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-4 mb-8 p-4 border border-indigo-200 bg-indigo-50 rounded-xl shadow-inner">
                    <div class="col-span-full">
                        <label for="loan-name" class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Deuda</label>
                        <input type="text" id="loan-name" name="loan_name" class="input-style" placeholder="Ej: Crédito Hipotecario, Préstamo Personal" required>
                    </div>
                    
                    <!-- Columna 1: Montos -->
                    <div>
                        <label for="loan-total-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto Total Original</label>
                        <input type="number" step="0.01" min="0" id="loan-total-amount" name="loan_total_amount" class="input-style" placeholder="10000.00" required>
                    </div>
                    <div>
                        <label for="loan-paid-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto Pagado a la Fecha</label>
                        <input type="number" step="0.01" min="0" id="loan-paid-amount" name="loan_paid_amount" class="input-style" placeholder="2500.00" required>
                    </div>
                    
                    <!-- Columna 2: Pagos -->
                    <div>
                        <label for="loan-total-payments" class="block text-sm font-medium text-gray-700 mb-1">Total de Pagos (Meses/Cuotas)</label>
                        <input type="number" min="1" id="loan-total-payments" name="loan_total_payments" class="input-style" placeholder="60" required>
                    </div>
                    <div>
                        <label for="loan-payments-made" class="block text-sm font-medium text-gray-700 mb-1">Pagos Realizados (Cuotas)</label>
                        <input type="number" min="0" id="loan-payments-made" name="loan_payments_made" class="input-style" placeholder="10" required>
                    </div>
                    
                    <!-- Columna 3: Monto de Pago -->
                    <div class="sm:col-span-1">
                        <label for="loan-payment-amount" class="block text-sm font-medium text-gray-700 mb-1">Monto de Cada Pago Estimado</label>
                        <input type="number" step="0.01" min="0" id="loan-payment-amount" name="loan_payment_amount" class="input-style" placeholder="200.00" required>
                    </div>

                    <div class="col-span-full mt-2">
                        <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-lg">
                            Guardar Préstamo/Deuda
                        </button>
                    </div>
                </form>

                <!-- Lista de Préstamos -->
                <h3 class="text-xl font-semibold text-gray-700 mb-3 border-t pt-4">Deudas Registradas</h3>
                <div id="loans-list" class="divide-y divide-gray-100">
                    <!-- Lista de préstamos cargada por loadLoans() -->
                </div>
            </section>

            <!-- ---------------------------------------------------------------------- -->
            <!-- SECCIÓN 4: CALCULADORA DE INTERÉS COMPUESTO -->
            <!-- ---------------------------------------------------------------------- -->
            <section id="interest-section" class="content-section bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Calculadora de Interés Compuesto</h2>
                
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <!-- Columna de Ingreso de Datos -->
                    <div class="lg:col-span-2">
                        <form id="interest-form" class="grid grid-cols-1 sm:grid-cols-2 gap-4 bg-gray-50 p-4 rounded-xl border border-gray-200">
                            <div>
                                <label for="principal" class="block text-sm font-medium text-gray-700 mb-1">Monto Principal Inicial ($)</label>
                                <input type="number" step="0.01" min="0" id="principal" name="principal" class="input-style" placeholder="10000" required>
                            </div>
                            <div>
                                <label for="rate" class="block text-sm font-medium text-gray-700 mb-1">Tasa de Interés Anual (%)</label>
                                <input type="number" step="0.01" min="0" id="rate" name="rate" class="input-style" placeholder="5.5" required>
                            </div>
                            <div>
                                <label for="time" class="block text-sm font-medium text-gray-700 mb-1">Años de Inversión</label>
                                <input type="number" min="1" id="time" name="time" class="input-style" placeholder="10" required>
                            </div>
                            <div>
                                <label for="compounds" class="block text-sm font-medium text-gray-700 mb-1">Veces que se Capitaliza al Año (n)</label>
                                <input type="number" min="1" id="compounds" name="compounds" class="input-style" placeholder="12 (mensual)" required>
                            </div>
                            <div class="col-span-full mt-2">
                                <button type="submit" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-lg">
                                    Calcular Valor Futuro
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Columna de Resultados -->
                    <div id="interest-results-card" class="bg-indigo-600 text-white p-6 rounded-xl shadow-2xl flex flex-col justify-center hidden">
                        <p class="text-sm font-semibold opacity-80">Valor Futuro Total (A)</p>
                        <p id="future-value-display" class="text-4xl font-extrabold mb-4">$0.00</p>
                        
                        <p class="text-sm font-semibold opacity-80">Intereses Ganados</p>
                        <p id="interest-earned-display" class="text-2xl font-bold mb-6">$0.00</p>
                        
                        <button onclick="window.saveCurrentCalculation()" class="bg-white text-indigo-700 hover:bg-indigo-100 font-semibold py-2 rounded-lg transition duration-200">
                            Guardar Inversión (Deshabilitado)
                        </button>
                    </div>
                </div>
            </section>

            <!-- ---------------------------------------------------------------------- -->
            <!-- SECCIÓN 5: ASESOR DE IA (GEMINI API) -->
            <!-- ---------------------------------------------------------------------- -->
            <section id="ai-section" class="content-section bg-white p-6 rounded-2xl shadow-xl">
                <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Asesor Financiero con Inteligencia Artificial</h2>
                
                <p class="text-gray-600 mb-4">Consulta sobre estrategias de ahorro, inversión o pide un análisis basado en tus transacciones multi-moneda registradas. **(Recuerda que no intenta sumar valores de diferentes monedas)**</p>

                <form id="ai-form" class="flex flex-col space-y-4">
                    <textarea id="ai-prompt" rows="3" class="input-style resize-none" placeholder="Ej: ¿Cómo puedo reducir mis gastos en MXN? O ¿Qué debo hacer con mis ingresos en USD para empezar a invertir?" required></textarea>
                    <button type="submit" id="ai-submit-button" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-lg flex justify-center items-center space-x-2">
                        <svg id="ai-loader" class="animate-spin h-5 w-5 text-white mr-3 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                        <span>Obtener Recomendación</span>
                    </button>
                </form>

                <div class="mt-8 p-6 bg-gray-50 border border-gray-200 rounded-xl shadow-inner">
                    <h3 class="text-lg font-bold text-gray-700 mb-3 flex items-center space-x-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-1.049-8.75-3.084M4.255 10.745A23.931 23.931 0 0112 9c3.183 0 6.22 1.049 8.75 3.084m-4.595-3.084l-4.243-4.243m0 0l-4.243 4.243m4.243-4.243V3" /></svg>
                        <span>Respuesta del Asesor IA</span>
                    </h3>
                    <div id="ai-output" class="prose text-gray-800">
                        <p>Las respuestas aparecerán aquí. Pruébalo con una consulta financiera.</p>
                    </div>
                </div>
            </section>
            
        </div>
    </div>
    
    <!-- ---------------------------------------------------------------------- -->
    <!-- MODAL DE AUTENTICACIÓN (LOGIN/REGISTRO) -->
    <!-- ---------------------------------------------------------------------- -->
    <div id="auth-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center hidden">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md m-4">
            <h3 class="text-2xl font-bold text-indigo-700 mb-4 text-center">Bienvenido a Finanzas PRO</h3>
            <p class="text-center text-gray-600 mb-6">Inicie sesión o regístrese para guardar sus datos de forma segura.</p>
            
            <form id="auth-form" class="space-y-4">
                <div>
                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="auth-email" name="auth_email" class="input-style" placeholder="tu@email.com" required>
                </div>
                <div>
                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">Contraseña</label>
                    <input type="password" id="auth-password" name="auth_password" class="input-style" placeholder="********" required>
                </div>
                
                <div class="flex space-x-4 pt-2">
                    <button type="submit" name="auth_action" value="login" class="w-1/2 bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-md">
                        Iniciar Sesión
                    </button>
                    <button type="submit" name="auth_action" value="register" class="w-1/2 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 rounded-xl transition duration-300 shadow-md">
                        Registrarse
                    </button>
                </div>
            </form>
            <p class="text-xs text-gray-400 mt-4 text-center">** Sus datos son privados y se guardan de forma segura con Firebase Firestore. **</p>
        </div>
    </div>

    <!-- ---------------------------------------------------------------------- -->
    <!-- MODAL DE ALERTA PERSONALIZADO (Reemplazo de alert()) -->
    <!-- ---------------------------------------------------------------------- -->
    <div id="alert-modal" class="fixed inset-0 z-50 bg-gray-900 bg-opacity-75 flex items-center justify-center transition-opacity duration-300 opacity-0 pointer-events-none">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm m-4 transform scale-100">
            <h4 id="alert-title" class="text-xl font-bold text-indigo-700 mb-3 border-b pb-2">Título</h4>
            <p id="alert-message" class="text-gray-700 mb-6">Mensaje</p>
            <button id="alert-close-btn" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-2 rounded-lg transition duration-200">
                Entendido
            </button>
        </div>
    </div>
</body>
</html>