<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planificador Financiero Completo (React + Firebase)</title>
    <!-- Carga de Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        /* Estilos de scrollbar para una mejor estética */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-thumb {
            background-color: #cbd5e1; /* gray-300 */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-track {
            background-color: #f1f5f9; /* gray-100 */
        }
        /* Altura mínima para la aplicación */
        #root {
            min-height: 100vh;
        }
        /* Animación de carga */
        .loader {
            border: 4px solid #f3f3f3; 
            border-top: 4px solid #3b82f6; 
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>

    <!-- 
    CRÍTICO: Carga de React y ReactDOM CDN ANTES de Babel.
    Se usan las versiones de producción (production.min.js) para mejor rendimiento y compatibilidad.
    -->
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <!-- Carga de Babel para procesar JSX directamente en el navegador -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- CRÍTICO: Carga de Lucide Icons (React Components) -->
    <script src="https://unpkg.com/lucide-react@0.320.0/dist/lucide-react.js"></script>
    
    <!-- Carga de Firebase CDN -->
    <script type="module">
        // FIX: setLogLevel se importa desde firebase-app.js, no desde firebase-app-check.js.
        import { initializeApp, setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, orderBy, runTransaction, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        // La línea original: import { setLogLevel } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app-check.js"; ha sido eliminada.
        
        // Inicialización de variables globales
        window.firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        window.initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        window.appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        let app, db, auth;

        // Función de inicialización
        window.initializeFirebase = async () => {
            try {
                // setLogLevel('debug'); // Descomentar para depuración
                
                app = initializeApp(window.firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // Autenticación: Usar token si está disponible, sino anónimo
                if (window.initialAuthToken) {
                    await signInWithCustomToken(auth, window.initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                // Exponer las instancias y funciones necesarias globalmente para el script Babel
                window.db = db;
                window.auth = auth;
                window.getDoc = getDoc;
                window.setDoc = setDoc;
                window.addDoc = addDoc;
                window.updateDoc = updateDoc;
                window.deleteDoc = deleteDoc;
                window.onSnapshot = onSnapshot;
                window.collection = collection;
                window.query = query;
                window.where = where;
                window.getDocs = getDocs;
                window.doc = doc;
                window.onAuthStateChanged = onAuthStateChanged;
                window.runTransaction = runTransaction;
                window.arrayUnion = arrayUnion;
                window.arrayRemove = arrayRemove;
                
                console.log("Firebase inicializado y autenticación iniciada.");

            } catch (error) {
                console.error("Error al inicializar Firebase o durante la autenticación:", error);
                document.getElementById('root').innerHTML = '<div class="flex items-center justify-center min-h-screen bg-red-50 p-8"><div class="p-10 text-center text-xl text-red-700 bg-red-100 rounded-xl shadow-lg border-l-4 border-red-500">❌ Error al inicializar Firebase: ' + (error.message || 'Verifique su configuración.') + '</div></div>';
            }
        };

        // Llamar a la inicialización
        window.initializeFirebase();

    </script>

    <!-- Contenedor principal de la aplicación React -->
    <div id="root">
        <!-- Pantalla de carga inicial mientras React y Firebase cargan -->
        <div class="flex items-center justify-center min-h-screen bg-gray-50">
            <div class="loader"></div>
            <p class="ml-4 text-gray-600">Cargando aplicación...</p>
        </div>
    </div>

    <!-- Script de la Aplicación React (procesado por Babel) -->
    <script type="text/babel">
        const { useState, useEffect, useCallback, useMemo, createContext, useContext } = React;

        // =========================================================================
        // CONSTANTES Y UTILIDADES
        // =========================================================================

        const EXPENSE_TYPES = ['fijo', 'variable', 'discrecional'];
        const INCOME_TYPES = ['salario', 'inversion', 'extra'];
        const DEFAULT_TAB = 'overview';
        const APP_COLLECTION_PATH = (userId) => `artifacts/${window.appId}/users/${userId}/financial_planner_data`;
        
        // Contexto para datos de la aplicación y autenticación
        const AppContext = createContext();

        // Hook para obtener el contexto
        const useAppContext = () => useContext(AppContext);

        // Componente para manejar los iconos de Lucide
        const Icon = ({ name, className = 'w-5 h-5', onClick, fill = 'none', strokeWidth = 2 }) => {
            // Obtenemos el objeto global 'lucide' que contiene todos los componentes de icono.
            const icons = typeof lucide !== 'undefined' ? lucide : {};

            // CRÍTICO: El error 'icons[name].toSvg is not a function' ocurre porque
            // los iconos de lucide-react son componentes React, no objetos con un método .toSvg().
            // La solución es renderizar el componente React directamente.
            
            // Los nombres de los iconos en lucide-react están en PascalCase (ej: 'home' -> 'Home')
            const capitalizedName = name.charAt(0).toUpperCase() + name.slice(1);
            const TargetIcon = icons[capitalizedName];
            
            if (!TargetIcon) {
                console.error(`Icon component: Icon '${capitalizedName}' not found in lucide.`);
                // Usar un icono de fallback (AlertCircle)
                const FallbackIcon = icons.AlertCircle;
                return FallbackIcon ? <FallbackIcon className={`${className} text-red-500`} /> : null;
            }

            // Renderizar el componente React del icono
            return (
                <TargetIcon 
                    className={className} 
                    onClick={onClick} 
                    fill={fill} 
                    strokeWidth={strokeWidth}
                />
            );
        };
        
        // Componente de navegación
        const NavButton = ({ tab, currentTab, iconName, label, onClick }) => {
            const isActive = currentTab === tab;
            const activeClasses = 'bg-blue-600 text-white shadow-lg shadow-blue-500/50';
            const inactiveClasses = 'text-gray-600 hover:bg-gray-100';

            return (
                <button
                    onClick={() => onClick(tab)}
                    className={`flex items-center space-x-2 px-4 py-2 rounded-xl transition-all duration-200 ${isActive ? activeClasses : inactiveClasses}`}
                >
                    <Icon name={iconName} className="w-5 h-5" />
                    <span className="font-medium text-sm hidden sm:inline-block">{label}</span>
                </button>
            );
        };

        // Componente de la barra de navegación principal
        const Navigation = ({ currentTab, setCurrentTab }) => {
            const navItems = [
                { tab: 'overview', iconName: 'LayoutDashboard', label: 'Resumen' },
                { tab: 'transactions', iconName: 'ListChecks', label: 'Transacciones' },
                { tab: 'goals', iconName: 'Target', label: 'Metas' },
                { tab: 'analysis', iconName: 'LineChart', label: 'Análisis' },
            ];

            return (
                <div className="flex justify-center sm:justify-start">
                    <nav className="flex space-x-2 p-2 bg-white rounded-2xl shadow-xl">
                        {navItems.map(item => (
                            <NavButton
                                key={item.tab}
                                tab={item.tab}
                                currentTab={currentTab}
                                iconName={item.iconName}
                                label={item.label}
                                onClick={setCurrentTab}
                            />
                        ))}
                    </nav>
                </div>
            );
        };

        // =========================================================================
        // FIREBASE / ESTADO GLOBAL
        // =========================================================================
        
        const AppProvider = ({ children }) => {
            const [isAuthReady, setIsAuthReady] = useState(false);
            const [userId, setUserId] = useState(null);
            const [data, setData] = useState({
                transactions: [],
                goals: [],
                lastUpdate: null,
                settings: { currency: 'USD' }
            });
            const [isLoading, setIsLoading] = useState(true);
            const [dbInstance, setDbInstance] = useState(null);
            const [authInstance, setAuthInstance] = useState(null);
            const [error, setError] = useState(null);

            // 1. Inicialización de Firebase y Autenticación
            useEffect(() => {
                const init = async () => {
                    // Esperar a que la inicialización de Firebase en el script module se complete
                    await new Promise(resolve => setTimeout(resolve, 50)); 
                    
                    if (window.db && window.auth) {
                        setDbInstance(window.db);
                        setAuthInstance(window.auth);
                        
                        // Escuchar cambios de autenticación
                        const unsubscribe = window.onAuthStateChanged(window.auth, (user) => {
                            if (user) {
                                setUserId(user.uid);
                                console.log("Usuario autenticado:", user.uid);
                            } else {
                                // Esto solo debería ocurrir si signInAnonymously falla
                                console.warn("Usuario no autenticado. Usando ID aleatorio.");
                                setUserId(crypto.randomUUID());
                            }
                            setIsAuthReady(true);
                        });
                        return () => unsubscribe();
                    } else {
                         // Si initializeFirebase falló, el error ya se habrá mostrado.
                        setIsAuthReady(true);
                        setError("Firebase no se inicializó correctamente.");
                    }
                };
                init();
            }, []);

            // 2. Escucha de datos de Firestore
            useEffect(() => {
                if (!isAuthReady || !dbInstance || !userId) return;

                const userDocRef = window.doc(dbInstance, APP_COLLECTION_PATH(userId), 'user_data');
                
                setIsLoading(true);

                // Función de escucha en tiempo real
                const unsubscribe = window.onSnapshot(userDocRef, (docSnap) => {
                    console.log("Datos de Firestore recibidos.");
                    if (docSnap.exists()) {
                        const firestoreData = docSnap.data();
                        
                        // Deserialización: Es CRÍTICO para arrays anidados (como transacciones)
                        const transactions = firestoreData.transactions 
                            ? JSON.parse(firestoreData.transactions) 
                            : [];
                        const goals = firestoreData.goals 
                            ? JSON.parse(firestoreData.goals) 
                            : [];
                            
                        setData({
                            transactions: transactions,
                            goals: goals,
                            lastUpdate: firestoreData.lastUpdate,
                            settings: firestoreData.settings || { currency: 'USD' }
                        });
                    } else {
                        console.log("Documento no existe, usando valores por defecto.");
                        setData(prev => ({ ...prev, lastUpdate: new Date().toISOString() }));
                        // Crea el documento inicial si no existe (lo haremos en save)
                    }
                    setIsLoading(false);
                }, (err) => {
                    console.error("Error al escuchar Firestore:", err);
                    setError("Error al cargar datos: " + err.message);
                    setIsLoading(false);
                });

                return () => unsubscribe();
            }, [isAuthReady, dbInstance, userId]); 

            // 3. Función de guardado
            const saveData = useCallback(async (updates) => {
                if (!dbInstance || !userId) {
                    console.error("No se puede guardar: DB o User ID no están listos.");
                    return;
                }

                setIsLoading(true);
                const userDocRef = window.doc(dbInstance, APP_COLLECTION_PATH(userId), 'user_data');
                const now = new Date().toISOString();
                
                // Serialización: Es CRÍTICO para arrays de objetos antes de guardar
                const dataToSave = {
                    ...updates,
                    lastUpdate: now,
                    // Si las transacciones o metas se actualizaron, serializarlas
                    transactions: updates.transactions ? JSON.stringify(updates.transactions) : data.transactions ? JSON.stringify(data.transactions) : '[]',
                    goals: updates.goals ? JSON.stringify(updates.goals) : data.goals ? JSON.stringify(data.goals) : '[]',
                    settings: updates.settings || data.settings,
                };

                try {
                    await window.setDoc(userDocRef, dataToSave, { merge: true });
                    console.log("Datos guardados exitosamente.");
                } catch (e) {
                    console.error("Error al guardar datos:", e);
                    setError("Error al guardar datos: " + e.message);
                } finally {
                    setIsLoading(false);
                }
            }, [dbInstance, userId, data.transactions, data.goals, data.settings]);
            
            // 4. Funciones específicas de Transacciones
            const addTransaction = useCallback(async (newTransaction) => {
                const newTransactions = [...data.transactions, {
                    ...newTransaction,
                    id: crypto.randomUUID(),
                    date: newTransaction.date || new Date().toISOString().split('T')[0]
                }];
                await saveData({ transactions: newTransactions });
            }, [data.transactions, saveData]);

            const deleteTransaction = useCallback(async (id) => {
                const newTransactions = data.transactions.filter(t => t.id !== id);
                await saveData({ transactions: newTransactions });
            }, [data.transactions, saveData]);

            // 5. Funciones específicas de Metas
            const addOrUpdateGoal = useCallback(async (goal) => {
                let newGoals;
                if (goal.id) {
                    newGoals = data.goals.map(g => g.id === goal.id ? goal : g);
                } else {
                    newGoals = [...data.goals, { ...goal, id: crypto.randomUUID() }];
                }
                await saveData({ goals: newGoals });
            }, [data.goals, saveData]);

            const deleteGoal = useCallback(async (id) => {
                const newGoals = data.goals.filter(g => g.id !== id);
                await saveData({ goals: newGoals });
            }, [data.goals, saveData]);
            
            // 6. Configuración
            const updateSettings = useCallback(async (newSettings) => {
                const updatedSettings = { ...data.settings, ...newSettings };
                await saveData({ settings: updatedSettings });
            }, [data.settings, saveData]);


            const contextValue = {
                data,
                isLoading,
                error,
                userId,
                isAuthReady,
                saveData,
                addTransaction,
                deleteTransaction,
                addOrUpdateGoal,
                deleteGoal,
                updateSettings,
                currency: data.settings.currency || 'USD'
            };

            if (!isAuthReady && !error) {
                return (
                    <div className="flex items-center justify-center min-h-screen bg-gray-50">
                        <div className="loader"></div>
                        <p className="ml-4 text-gray-600">Conectando con Firebase...</p>
                    </div>
                );
            }

            if (error) {
                 return (
                    <div className="flex items-center justify-center min-h-screen bg-red-50 p-8">
                        <div className="p-10 text-center text-xl text-red-700 bg-red-100 rounded-xl shadow-lg border-l-4 border-red-500">
                            ❌ Error Crítico: {error}
                        </div>
                    </div>
                );
            }

            return (
                <AppContext.Provider value={contextValue}>
                    {children}
                </AppContext.Provider>
            );
        };

        // =========================================================================
        // COMPONENTES DE VISTA (PÁGINAS)
        // =========================================================================

        const formatCurrency = (amount, currency) => {
            return new Intl.NumberFormat('es-US', {
                style: 'currency',
                currency: currency,
                minimumFractionDigits: 2,
            }).format(amount);
        };
        
        // Componente de entrada genérico
        const InputField = ({ label, type = 'text', value, onChange, name, placeholder, className = '' }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-sm font-medium text-gray-700 mb-1">{label}</label>
                <input
                    type={type}
                    name={name}
                    value={value}
                    onChange={onChange}
                    placeholder={placeholder}
                    className="p-2 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                />
            </div>
        );
        
        // Componente de selección genérico
        const SelectField = ({ label, value, onChange, name, options, className = '' }) => (
            <div className={`flex flex-col ${className}`}>
                <label className="text-sm font-medium text-gray-700 mb-1">{label}</label>
                <select
                    name={name}
                    value={value}
                    onChange={onChange}
                    className="p-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500 transition duration-150"
                >
                    {options.map(option => (
                        <option key={option.value} value={option.value}>
                            {option.label}
                        </option>
                    ))}
                </select>
            </div>
        );


        // =========================================================================
        // PÁGINA 1: RESUMEN (OVERVIEW)
        // =========================================================================

        const Overview = () => {
            const { data, currency, isLoading } = useAppContext();
            const { transactions, goals } = data;

            // Cálculos
            const { totalIncome, totalExpenses, savingsRate, balance, groupedExpenses } = useMemo(() => {
                const now = new Date();
                const currentMonth = now.getMonth();
                const currentYear = now.getFullYear();

                const monthlyTransactions = transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return tDate.getMonth() === currentMonth && tDate.getFullYear() === currentYear;
                });

                const totalIncome = monthlyTransactions
                    .filter(t => t.type === 'ingreso')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);

                const totalExpenses = monthlyTransactions
                    .filter(t => t.type === 'gasto')
                    .reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                    
                const balance = totalIncome - totalExpenses;
                
                // Asumiendo que el ahorro es el balance si es positivo
                const totalSavings = Math.max(0, balance);
                const savingsRate = totalIncome > 0 ? (totalSavings / totalIncome) * 100 : 0;
                
                // Agrupación de gastos por tipo
                const groupedExpenses = monthlyTransactions
                    .filter(t => t.type === 'gasto')
                    .reduce((acc, t) => {
                        const expenseType = t.expenseType || 'discrecional'; // Usar un valor por defecto
                        acc[expenseType] = (acc[expenseType] || 0) + parseFloat(t.amount || 0);
                        return acc;
                    }, {});


                return { totalIncome, totalExpenses, savingsRate, balance, groupedExpenses };
            }, [transactions]);
            
            const totalGoalNeeded = useMemo(() => {
                return goals.reduce((sum, goal) => sum + parseFloat(goal.targetAmount || 0), 0);
            }, [goals]);

            const totalGoalSaved = useMemo(() => {
                 return goals.reduce((sum, goal) => sum + parseFloat(goal.savedAmount || 0), 0);
            }, [goals]);

            const getGoalProgress = (saved, target) => {
                if (target <= 0) return 0;
                return Math.min(100, (saved / target) * 100);
            };

            const Card = ({ title, value, iconName, color }) => (
                <div className="bg-white p-6 rounded-2xl shadow-xl flex items-center justify-between transition-all duration-300 hover:shadow-2xl hover:scale-[1.01]">
                    <div>
                        <p className="text-sm font-semibold text-gray-500">{title}</p>
                        <p className={`text-3xl font-bold ${color}`}>{value}</p>
                    </div>
                    <Icon name={iconName} className={`w-10 h-10 p-2 rounded-full ${color.replace('text-', 'bg-').replace('600', '100')} ${color}`} strokeWidth={1.5} />
                </div>
            );

            const ProgressPill = ({ label, percentage }) => (
                <div className="flex items-center space-x-3 text-sm font-medium">
                    <span className="text-gray-700 w-24">{label}</span>
                    <div className="flex-grow bg-gray-200 rounded-full h-2.5">
                        <div 
                            className="h-2.5 rounded-full transition-all duration-500" 
                            style={{ 
                                width: `${percentage}%`, 
                                backgroundColor: percentage >= 100 ? '#10b981' : percentage > 50 ? '#f59e0b' : '#ef4444' 
                            }}
                        ></div>
                    </div>
                    <span className="text-gray-500 w-12 text-right">{percentage.toFixed(0)}%</span>
                </div>
            );

            return (
                <div className="space-y-8 p-4 sm:p-8">
                    <h2 className="text-3xl font-extrabold text-gray-900 border-b pb-2">Resumen Mensual</h2>
                    
                    {isLoading ? (
                        <div className="flex justify-center items-center h-48">
                            <div className="loader"></div>
                            <p className="ml-4 text-gray-600">Calculando finanzas...</p>
                        </div>
                    ) : (
                        <>
                            <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                                <Card 
                                    title="Ingreso Total (Mes)" 
                                    value={formatCurrency(totalIncome, currency)} 
                                    iconName="TrendingUp" 
                                    color="text-green-600" 
                                />
                                <Card 
                                    title="Gasto Total (Mes)" 
                                    value={formatCurrency(totalExpenses, currency)} 
                                    iconName="TrendingDown" 
                                    color="text-red-600" 
                                />
                                <Card 
                                    title="Balance Neto (Mes)" 
                                    value={formatCurrency(balance, currency)} 
                                    iconName="Wallet" 
                                    color={balance >= 0 ? "text-blue-600" : "text-orange-600"} 
                                />
                                <Card 
                                    title="Tasa de Ahorro" 
                                    value={`${savingsRate.toFixed(1)}%`} 
                                    iconName="Percent" 
                                    color="text-purple-600" 
                                />
                            </div>

                            {/* Detalle de Metas y Gastos */}
                            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8">
                                
                                {/* Resumen de Metas */}
                                <div className="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center">
                                        <Icon name="Target" className="w-6 h-6 mr-2 text-blue-600" /> Metas de Ahorro
                                    </h3>
                                    
                                    <div className="space-y-2">
                                        <p className="text-sm text-gray-500">Total Meta: <span className="font-semibold text-gray-700">{formatCurrency(totalGoalNeeded, currency)}</span></p>
                                        <p className="text-sm text-gray-500">Total Ahorrado: <span className="font-semibold text-blue-600">{formatCurrency(totalGoalSaved, currency)}</span></p>
                                        <ProgressPill 
                                            label="Progreso General"
                                            percentage={getGoalProgress(totalGoalSaved, totalGoalNeeded)}
                                        />
                                    </div>
                                    <div className="pt-4 border-t border-gray-100 space-y-2 max-h-64 overflow-y-auto">
                                        {goals.length > 0 ? goals.map(goal => (
                                            <ProgressPill 
                                                key={goal.id} 
                                                label={goal.name} 
                                                percentage={getGoalProgress(parseFloat(goal.savedAmount || 0), parseFloat(goal.targetAmount || 0))} 
                                            />
                                        )) : (
                                            <p className="text-gray-500 text-sm">Aún no hay metas. ¡Define algunas!</p>
                                        )}
                                    </div>
                                </div>

                                {/* Desglose de Gastos */}
                                <div className="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                                    <h3 className="text-xl font-bold text-gray-800 flex items-center">
                                        <Icon name="PieChart" className="w-6 h-6 mr-2 text-red-600" /> Desglose de Gastos
                                    </h3>
                                    <div className="space-y-3">
                                        {EXPENSE_TYPES.map(type => {
                                            const amount = groupedExpenses[type] || 0;
                                            const percentage = totalExpenses > 0 ? (amount / totalExpenses) * 100 : 0;
                                            return (
                                                <div key={type} className="flex justify-between items-center">
                                                    <span className="capitalize text-gray-700 font-medium">{type}</span>
                                                    <span className="text-gray-500">{formatCurrency(amount, currency)} ({percentage.toFixed(1)}%)</span>
                                                </div>
                                            );
                                        })}
                                        {totalExpenses === 0 && <p className="text-gray-500 text-sm">Aún no hay gastos registrados este mes.</p>}
                                    </div>
                                </div>

                            </div>
                        </>
                    )}
                </div>
            );
        };
        
        // =========================================================================
        // PÁGINA 2: TRANSACCIONES
        // =========================================================================

        const TransactionForm = ({ transactionToEdit, onSave, onCancel }) => {
            const { currency, deleteTransaction } = useAppContext();
            const initialState = transactionToEdit || {
                id: null,
                name: '',
                amount: '',
                type: 'gasto', // 'gasto' o 'ingreso'
                category: '',
                date: new Date().toISOString().split('T')[0],
                expenseType: 'discrecional' // solo para gastos
            };

            const [formData, setFormData] = useState(initialState);
            const [isSaving, setIsSaving] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);

            useEffect(() => {
                setFormData(transactionToEdit || initialState);
            }, [transactionToEdit]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                const amountValue = parseFloat(formData.amount);
                if (isNaN(amountValue) || amountValue <= 0) {
                    // CRÍTICO: Usar un modal o UI para mostrar el mensaje, no alert()
                    // Reemplazando alert() con una lógica de manejo de estado simple
                    console.error('Por favor, introduce una cantidad válida.'); 
                    setIsSaving(false);
                    return;
                }

                await onSave({ ...formData, amount: amountValue.toFixed(2) });
                setIsSaving(false);
                onCancel();
            };
            
            const handleDelete = async () => {
                if (formData.id) {
                    setIsSaving(true);
                    await deleteTransaction(formData.id);
                    setIsSaving(false);
                    onCancel();
                }
            };
            
            const expenseOptions = [
                { value: 'fijo', label: 'Fijo (Ej: Alquiler)' },
                { value: 'variable', label: 'Variable (Ej: Comida)' },
                { value: 'discrecional', label: 'Discrecional (Ej: Entretenimiento)' },
            ];
            
            const incomeOptions = [
                { value: 'salario', label: 'Salario' },
                { value: 'inversion', label: 'Inversión' },
                { value: 'extra', label: 'Extra' },
            ];

            return (
                <div className="p-6 bg-white rounded-xl shadow-2xl max-w-lg mx-auto transition-all">
                    <h3 className="text-2xl font-bold text-gray-900 mb-6 border-b pb-2">
                        {transactionToEdit ? 'Editar Transacción' : 'Nueva Transacción'}
                    </h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        
                        <SelectField
                            label="Tipo"
                            name="type"
                            value={formData.type}
                            onChange={handleChange}
                            options={[
                                { value: 'gasto', label: 'Gasto' },
                                { value: 'ingreso', label: 'Ingreso' },
                            ]}
                        />
                        
                        {/* Campo de Tipo de Gasto/Ingreso */}
                        {formData.type === 'gasto' ? (
                            <SelectField
                                label="Clasificación de Gasto"
                                name="expenseType"
                                value={formData.expenseType}
                                onChange={handleChange}
                                options={expenseOptions}
                            />
                        ) : (
                             <SelectField
                                label="Origen de Ingreso"
                                name="category"
                                value={formData.category}
                                onChange={handleChange}
                                options={incomeOptions}
                            />
                        )}

                        <InputField
                            label="Descripción"
                            type="text"
                            name="name"
                            value={formData.name}
                            onChange={handleChange}
                            placeholder="Ej: Pago de alquiler, Salario mensual"
                            required
                        />

                        <InputField
                            label={`Monto (${currency})`}
                            type="number"
                            name="amount"
                            value={formData.amount}
                            onChange={handleChange}
                            placeholder="0.00"
                            step="0.01"
                            required
                        />

                        <InputField
                            label="Fecha"
                            type="date"
                            name="date"
                            value={formData.date}
                            onChange={handleChange}
                            required
                        />

                        <div className="flex justify-between pt-4 space-x-3">
                            <button
                                type="button"
                                onClick={onCancel}
                                className="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150 flex justify-center items-center"
                                disabled={isSaving}
                            >
                                {isSaving ? <Icon name="Loader" className="w-5 h-5 animate-spin" /> : (transactionToEdit ? 'Guardar Cambios' : 'Añadir')}
                            </button>
                        </div>
                        
                        {transactionToEdit && (
                            <>
                                <button
                                    type="button"
                                    onClick={() => setShowConfirm(true)}
                                    className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-150 mt-2"
                                >
                                    Eliminar Transacción
                                </button>
                                {showConfirm && (
                                    <div className="p-4 mt-4 border border-red-300 bg-red-50 rounded-lg space-y-3">
                                        <p className="text-sm text-red-700">¿Estás seguro que quieres eliminar esta transacción?</p>
                                        <div className="flex justify-end space-x-2">
                                            <button 
                                                type="button" 
                                                onClick={() => setShowConfirm(false)}
                                                className="px-3 py-1 text-sm bg-gray-300 rounded-lg hover:bg-gray-400"
                                            >
                                                No
                                            </button>
                                            <button 
                                                type="button" 
                                                onClick={handleDelete}
                                                className="px-3 py-1 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700"
                                                disabled={isSaving}
                                            >
                                                Sí, Eliminar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </form>
                </div>
            );
        };
        
        const TransactionItem = ({ transaction, onEdit, currency }) => {
            const amountClass = transaction.type === 'ingreso' ? 'text-green-600' : 'text-red-600';
            const iconName = transaction.type === 'ingreso' ? 'ArrowUpCircle' : 'ArrowDownCircle';
            const categoryLabel = transaction.type === 'gasto' ? 
                                  `Tipo de Gasto: ${transaction.expenseType || 'N/A'}` : 
                                  `Origen: ${transaction.category || 'N/A'}`;
            
            return (
                <div 
                    className="flex items-center justify-between p-4 bg-white rounded-xl shadow-md cursor-pointer hover:bg-gray-50 transition duration-150"
                    onClick={() => onEdit(transaction)}
                >
                    <div className="flex items-center space-x-4">
                        <div className={`p-2 rounded-full ${transaction.type === 'ingreso' ? 'bg-green-100' : 'bg-red-100'}`}>
                            <Icon name={iconName} className={`w-5 h-5 ${amountClass}`} />
                        </div>
                        <div>
                            <p className="font-semibold text-gray-800">{transaction.name}</p>
                            <p className="text-xs text-gray-500 capitalize">{categoryLabel}</p>
                        </div>
                    </div>
                    
                    <div className="text-right">
                        <p className={`font-bold ${amountClass}`}>
                            {formatCurrency(parseFloat(transaction.amount || 0), currency)}
                        </p>
                        <p className="text-xs text-gray-400">{transaction.date}</p>
                    </div>
                </div>
            );
        };


        const Transactions = () => {
            const { data, addTransaction, isLoading, currency } = useAppContext();
            const [showModal, setShowModal] = useState(false);
            const [editingTransaction, setEditingTransaction] = useState(null);
            const [filterType, setFilterType] = useState('todos'); // 'todos', 'gasto', 'ingreso'
            const [sortOrder, setSortOrder] = useState('desc'); // 'asc', 'desc'

            const openModal = (transaction = null) => {
                setEditingTransaction(transaction);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setEditingTransaction(null);
            };
            
            const handleSave = async (transaction) => {
                await addTransaction(transaction); // addTransaction también maneja la edición
            };

            const toggleSortOrder = () => {
                setSortOrder(prev => prev === 'desc' ? 'asc' : 'desc');
            };

            const sortedAndFilteredTransactions = useMemo(() => {
                let filtered = data.transactions;

                if (filterType !== 'todos') {
                    filtered = filtered.filter(t => t.type === filterType);
                }

                // Ordenar por fecha. CRÍTICO: Ordenar en el cliente (JS) para evitar errores de índices en Firestore.
                const sorted = [...filtered].sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    if (sortOrder === 'desc') {
                        return dateB - dateA;
                    }
                    return dateA - dateB;
                });

                return sorted;
            }, [data.transactions, filterType, sortOrder]);


            return (
                <div className="p-4 sm:p-8 space-y-6">
                    <div className="flex justify-between items-center border-b pb-2">
                        <h2 className="text-3xl font-extrabold text-gray-900">Transacciones</h2>
                        <button
                            onClick={() => openModal()}
                            className="flex items-center space-x-2 py-2 px-4 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 shadow-md transition duration-150"
                        >
                            <Icon name="Plus" className="w-5 h-5" />
                            <span className="hidden sm:inline">Añadir</span>
                        </button>
                    </div>
                    
                    {/* Controles de Filtrado y Ordenamiento */}
                    <div className="flex flex-wrap gap-4 items-center bg-gray-50 p-4 rounded-xl shadow-inner">
                        <SelectField
                            label="Filtrar por Tipo"
                            value={filterType}
                            onChange={(e) => setFilterType(e.target.value)}
                            options={[
                                { value: 'todos', label: 'Todos' },
                                { value: 'gasto', label: 'Gastos' },
                                { value: 'ingreso', label: 'Ingresos' },
                            ]}
                            className="w-full sm:w-auto"
                        />
                         <div className="flex flex-col">
                            <label className="text-sm font-medium text-gray-700 mb-1">Ordenar por Fecha</label>
                            <button
                                onClick={toggleSortOrder}
                                className="flex items-center space-x-2 py-2 px-4 bg-white border border-gray-300 text-gray-700 font-semibold rounded-lg hover:bg-gray-100 transition duration-150"
                            >
                                <Icon name={sortOrder === 'desc' ? 'ArrowDownAZ' : 'ArrowUpAZ'} className="w-5 h-5" />
                                <span>{sortOrder === 'desc' ? 'Más Reciente' : 'Más Antiguo'}</span>
                            </button>
                        </div>
                    </div>


                    {isLoading ? (
                         <div className="flex justify-center items-center h-64">
                            <div className="loader"></div>
                            <p className="ml-4 text-gray-600">Cargando transacciones...</p>
                        </div>
                    ) : sortedAndFilteredTransactions.length === 0 ? (
                        <div className="text-center p-10 bg-white rounded-xl shadow-md">
                            <Icon name="Frown" className="w-12 h-12 mx-auto text-gray-400 mb-4" />
                            <p className="text-gray-600">No hay transacciones registradas. ¡Empieza añadiendo una!</p>
                        </div>
                    ) : (
                        <div className="space-y-3 max-h-[70vh] overflow-y-auto pr-2">
                            {sortedAndFilteredTransactions.map(t => (
                                <TransactionItem 
                                    key={t.id} 
                                    transaction={t} 
                                    onEdit={openModal} 
                                    currency={currency}
                                />
                            ))}
                        </div>
                    )}

                    {/* Modal para añadir/editar */}
                    {showModal && (
                        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity">
                            <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={closeModal} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                                    <Icon name="X" className="w-6 h-6" />
                                </button>
                                <TransactionForm 
                                    transactionToEdit={editingTransaction} 
                                    onSave={handleSave} 
                                    onCancel={closeModal} 
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };
        
        // =========================================================================
        // PÁGINA 3: METAS
        // =========================================================================

        const GoalForm = ({ goalToEdit, onSave, onCancel }) => {
            const { currency, deleteGoal } = useAppContext();
            const initialState = goalToEdit || {
                id: null,
                name: '',
                targetAmount: '',
                savedAmount: 0,
                targetDate: '',
            };

            const [formData, setFormData] = useState(initialState);
            const [isSaving, setIsSaving] = useState(false);
            const [showConfirm, setShowConfirm] = useState(false);

            useEffect(() => {
                setFormData(goalToEdit || initialState);
            }, [goalToEdit]);

            const handleChange = (e) => {
                const { name, value } = e.target;
                setFormData(prev => ({ ...prev, [name]: value }));
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                setIsSaving(true);
                
                const targetAmountValue = parseFloat(formData.targetAmount);
                if (isNaN(targetAmountValue) || targetAmountValue <= 0) {
                    // CRÍTICO: Usar un modal o UI para mostrar el mensaje, no alert()
                    // Reemplazando alert() con una lógica de manejo de estado simple
                    console.error('Por favor, introduce una meta de cantidad válida y positiva.');
                    setIsSaving(false);
                    return;
                }
                
                const savedAmountValue = parseFloat(formData.savedAmount || 0);

                await onSave({ 
                    ...formData, 
                    targetAmount: targetAmountValue.toFixed(2),
                    savedAmount: savedAmountValue.toFixed(2)
                });
                setIsSaving(false);
                onCancel();
            };
            
            const handleDelete = async () => {
                if (formData.id) {
                    setIsSaving(true);
                    await deleteGoal(formData.id);
                    setIsSaving(false);
                    onCancel();
                }
            };
            
            // Función para calcular el ahorro mensual requerido
            const monthlyRequired = useMemo(() => {
                const targetAmount = parseFloat(formData.targetAmount || 0);
                const savedAmount = parseFloat(formData.savedAmount || 0);
                const targetDate = formData.targetDate;

                if (targetAmount <= savedAmount || !targetDate) return 0;

                const today = new Date();
                const target = new Date(targetDate);

                // Calcular meses restantes
                const yearDiff = target.getFullYear() - today.getFullYear();
                const monthDiff = target.getMonth() - today.getMonth();
                let monthsRemaining = yearDiff * 12 + monthDiff;

                // Si la fecha objetivo ya pasó, o queda 0 o menos meses, considerar 1 mes para evitar división por cero
                monthsRemaining = Math.max(1, monthsRemaining); 

                const remainingAmount = targetAmount - savedAmount;
                
                return remainingAmount / monthsRemaining;

            }, [formData.targetAmount, formData.savedAmount, formData.targetDate]);


            return (
                <div className="p-6 bg-white rounded-xl shadow-2xl max-w-lg mx-auto transition-all">
                    <h3 className="text-2xl font-bold text-gray-900 mb-6 border-b pb-2">
                        {goalToEdit ? 'Editar Meta' : 'Nueva Meta de Ahorro'}
                    </h3>
                    <form onSubmit={handleSubmit} className="space-y-4">
                        
                        <InputField
                            label="Nombre de la Meta"
                            type="text"
                            name="name"
                            value={formData.name}
                            onChange={handleChange}
                            placeholder="Ej: Fondo de Emergencia, Vacaciones a Japón"
                            required
                        />

                        <InputField
                            label={`Monto Objetivo (${currency})`}
                            type="number"
                            name="targetAmount"
                            value={formData.targetAmount}
                            onChange={handleChange}
                            placeholder="5000.00"
                            step="0.01"
                            required
                        />
                        
                        <InputField
                            label={`Monto Ahorrado Actualmente (${currency})`}
                            type="number"
                            name="savedAmount"
                            value={formData.savedAmount}
                            onChange={handleChange}
                            placeholder="0.00"
                            step="0.01"
                            required
                        />

                        <InputField
                            label="Fecha Objetivo"
                            type="date"
                            name="targetDate"
                            value={formData.targetDate}
                            onChange={handleChange}
                            required
                        />
                        
                        {/* Indicador de Ahorro Mensual Requerido */}
                        {monthlyRequired > 0 && (
                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                                <p className="text-sm font-medium text-blue-800">
                                    Ahorro Mensual Requerido: <span className="font-bold">{formatCurrency(monthlyRequired, currency)}</span>
                                </p>
                            </div>
                        )}


                        <div className="flex justify-between pt-4 space-x-3">
                            <button
                                type="button"
                                onClick={onCancel}
                                className="w-full py-2 px-4 bg-gray-200 text-gray-700 font-semibold rounded-xl hover:bg-gray-300 transition duration-150"
                            >
                                Cancelar
                            </button>
                            <button
                                type="submit"
                                className="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 transition duration-150 flex justify-center items-center"
                                disabled={isSaving}
                            >
                                {isSaving ? <Icon name="Loader" className="w-5 h-5 animate-spin" /> : (goalToEdit ? 'Guardar Cambios' : 'Crear Meta')}
                            </button>
                        </div>
                        
                        {goalToEdit && (
                            <>
                                <button
                                    type="button"
                                    onClick={() => setShowConfirm(true)}
                                    className="w-full py-2 px-4 bg-red-500 text-white font-semibold rounded-xl hover:bg-red-600 transition duration-150 mt-2"
                                >
                                    Eliminar Meta
                                </button>
                                {showConfirm && (
                                    <div className="p-4 mt-4 border border-red-300 bg-red-50 rounded-lg space-y-3">
                                        <p className="text-sm text-red-700">¿Estás seguro que quieres eliminar esta meta?</p>
                                        <div className="flex justify-end space-x-2">
                                            <button 
                                                type="button" 
                                                onClick={() => setShowConfirm(false)}
                                                className="px-3 py-1 text-sm bg-gray-300 rounded-lg hover:bg-gray-400"
                                            >
                                                No
                                            </button>
                                            <button 
                                                type="button" 
                                                onClick={handleDelete}
                                                className="px-3 py-1 text-sm bg-red-600 text-white rounded-lg hover:bg-red-700"
                                                disabled={isSaving}
                                            >
                                                Sí, Eliminar
                                            </button>
                                        </div>
                                    </div>
                                )}
                            </>
                        )}
                    </form>
                </div>
            );
        };

        const GoalItem = ({ goal, onEdit, currency }) => {
            const saved = parseFloat(goal.savedAmount || 0);
            const target = parseFloat(goal.targetAmount || 0);
            const progress = target > 0 ? Math.min(100, (saved / target) * 100) : 0;
            const remaining = target - saved;
            
            const daysLeft = useMemo(() => {
                const today = new Date();
                const targetDate = new Date(goal.targetDate);
                const diffTime = targetDate.getTime() - today.getTime();
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                return diffDays;
            }, [goal.targetDate]);

            const progressBarColor = progress >= 100 ? 'bg-green-500' : 'bg-blue-500';

            return (
                <div 
                    className="p-6 bg-white rounded-xl shadow-lg hover:shadow-xl transition-all duration-200 cursor-pointer border-l-4 border-blue-500 space-y-3"
                    onClick={() => onEdit(goal)}
                >
                    <div className="flex justify-between items-start">
                        <h3 className="text-xl font-bold text-gray-800">{goal.name}</h3>
                        <span className={`text-sm font-semibold px-3 py-1 rounded-full ${daysLeft < 0 ? 'bg-red-100 text-red-600' : 'bg-gray-100 text-gray-600'}`}>
                            {daysLeft < 0 ? 'Expirada' : (daysLeft <= 30 ? `${daysLeft} días restantes` : goal.targetDate)}
                        </span>
                    </div>

                    {/* Barra de Progreso */}
                    <div className="w-full bg-gray-200 rounded-full h-3">
                        <div 
                            className={`h-3 rounded-full transition-all duration-500 ${progressBarColor}`} 
                            style={{ width: `${progress}%` }}
                        ></div>
                    </div>

                    <div className="flex justify-between text-sm font-medium">
                        <p className="text-gray-500">Ahorrado: <span className="text-gray-700 font-semibold">{formatCurrency(saved, currency)}</span></p>
                        <p className="text-gray-500">Meta: <span className="text-blue-600 font-semibold">{formatCurrency(target, currency)}</span></p>
                    </div>
                    
                    <div className="flex justify-between text-xs pt-2 border-t border-gray-100">
                        <p className="text-gray-500">Progreso: <span className="text-blue-600 font-bold">{progress.toFixed(1)}%</span></p>
                        <p className={`font-semibold ${remaining <= 0 ? 'text-green-600' : 'text-red-600'}`}>
                            {remaining > 0 ? `Faltan: ${formatCurrency(remaining, currency)}` : '¡Completada!'}
                        </p>
                    </div>
                </div>
            );
        };

        const Goals = () => {
            const { data, addOrUpdateGoal, isLoading, currency } = useAppContext();
            const [showModal, setShowModal] = useState(false);
            const [editingGoal, setEditingGoal] = useState(null);

            const openModal = (goal = null) => {
                setEditingGoal(goal);
                setShowModal(true);
            };

            const closeModal = () => {
                setShowModal(false);
                setEditingGoal(null);
            };
            
            const handleSave = async (goal) => {
                await addOrUpdateGoal(goal);
            };

            return (
                <div className="p-4 sm:p-8 space-y-6">
                    <div className="flex justify-between items-center border-b pb-2">
                        <h2 className="text-3xl font-extrabold text-gray-900">Metas de Ahorro</h2>
                        <button
                            onClick={() => openModal()}
                            className="flex items-center space-x-2 py-2 px-4 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 shadow-md transition duration-150"
                        >
                            <Icon name="Plus" className="w-5 h-5" />
                            <span className="hidden sm:inline">Nueva Meta</span>
                        </button>
                    </div>

                    {isLoading ? (
                         <div className="flex justify-center items-center h-64">
                            <div className="loader"></div>
                            <p className="ml-4 text-gray-600">Cargando metas...</p>
                        </div>
                    ) : data.goals.length === 0 ? (
                        <div className="text-center p-10 bg-white rounded-xl shadow-md">
                            <Icon name="Target" className="w-12 h-12 mx-auto text-gray-400 mb-4" />
                            <p className="text-gray-600">Aún no has establecido metas de ahorro. ¡Empieza a planificar tu futuro!</p>
                        </div>
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 max-h-[70vh] overflow-y-auto pr-2">
                            {data.goals.map(g => (
                                <GoalItem 
                                    key={g.id} 
                                    goal={g} 
                                    onEdit={openModal} 
                                    currency={currency}
                                />
                            ))}
                        </div>
                    )}
                    
                    {/* Modal para añadir/editar */}
                    {showModal && (
                        <div className="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center p-4 z-50 transition-opacity">
                            <div className="bg-white rounded-xl w-full max-w-lg shadow-2xl relative" onClick={e => e.stopPropagation()}>
                                <button onClick={closeModal} className="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                                    <Icon name="X" className="w-6 h-6" />
                                </button>
                                <GoalForm 
                                    goalToEdit={editingGoal} 
                                    onSave={handleSave} 
                                    onCancel={closeModal} 
                                />
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        // =========================================================================
        // PÁGINA 4: ANÁLISIS/CONFIGURACIÓN
        // =========================================================================

        const Analysis = () => {
            const { data, currency, updateSettings, userId, isLoading } = useAppContext();
            const [selectedCurrency, setSelectedCurrency] = useState(data.settings.currency || 'USD');
            const [isSaving, setIsSaving] = useState(false);
            const [saveMessage, setSaveMessage] = useState('');
            
            // Sincronizar estado local con global
            useEffect(() => {
                setSelectedCurrency(data.settings.currency || 'USD');
            }, [data.settings.currency]);
            
            // Análisis simple: Gasto promedio diario (basado en el último mes)
            const averageDailyExpense = useMemo(() => {
                const now = new Date();
                const last30Days = new Date();
                last30Days.setDate(now.getDate() - 30);
                
                const recentExpenses = data.transactions.filter(t => {
                    const tDate = new Date(t.date);
                    return t.type === 'gasto' && tDate >= last30Days;
                });
                
                const totalExpense = recentExpenses.reduce((sum, t) => sum + parseFloat(t.amount || 0), 0);
                
                if (totalExpense === 0) return 0;

                // Contar los días que tienen transacciones para evitar división por 0
                const daysWithTransactions = new Set(recentExpenses.map(t => t.date)).size;
                
                return totalExpense / Math.max(1, daysWithTransactions);
                
            }, [data.transactions]);

            const handleCurrencyChange = (e) => {
                setSelectedCurrency(e.target.value);
            };

            const handleSaveSettings = async () => {
                setIsSaving(true);
                await updateSettings({ currency: selectedCurrency });
                setSaveMessage('Ajustes guardados correctamente.');
                setTimeout(() => setSaveMessage(''), 3000);
                setIsSaving(false);
            };
            
            const currencyOptions = [
                { value: 'USD', label: 'Dólar Estadounidense (USD)' },
                { value: 'EUR', label: 'Euro (EUR)' },
                { value: 'MXN', label: 'Peso Mexicano (MXN)' },
                { value: 'COP', label: 'Peso Colombiano (COP)' },
                { value: 'CLP', label: 'Peso Chileno (CLP)' },
                { value: 'ARS', label: 'Peso Argentino (ARS)' },
            ];

            return (
                <div className="p-4 sm:p-8 space-y-8">
                    <h2 className="text-3xl font-extrabold text-gray-900 border-b pb-2">Análisis y Ajustes</h2>
                    
                    {/* Sección de Análisis Rápido */}
                    <div className="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-800 flex items-center mb-4">
                            <Icon name="BarChart2" className="w-6 h-6 mr-2 text-green-600" /> Análisis Rápido
                        </h3>
                        
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="p-4 bg-green-50 rounded-lg border border-green-200">
                                <p className="text-sm font-medium text-green-800">Gasto Promedio Diario (Últimos 30 días)</p>
                                <p className="text-2xl font-bold text-green-600">{formatCurrency(averageDailyExpense, currency)}</p>
                            </div>
                             <div className="p-4 bg-purple-50 rounded-lg border border-purple-200">
                                <p className="text-sm font-medium text-purple-800">Total de Transacciones</p>
                                <p className="text-2xl font-bold text-purple-600">{data.transactions.length}</p>
                            </div>
                        </div>
                        <p className="text-xs text-gray-500 pt-2">El análisis avanzado estará disponible en futuras versiones. ¡Por ahora, usa la vista de resumen!</p>
                    </div>


                    {/* Sección de Ajustes */}
                    <div className="bg-white p-6 rounded-2xl shadow-xl space-y-4">
                        <h3 className="text-xl font-bold text-gray-800 flex items-center mb-4">
                            <Icon name="Settings" className="w-6 h-6 mr-2 text-blue-600" /> Ajustes de la Aplicación
                        </h3>
                        
                        <SelectField
                            label="Moneda Predeterminada"
                            name="currency"
                            value={selectedCurrency}
                            onChange={handleCurrencyChange}
                            options={currencyOptions}
                            className="max-w-xs"
                        />
                        
                        <button
                            onClick={handleSaveSettings}
                            className="flex items-center space-x-2 py-2 px-4 bg-blue-600 text-white font-semibold rounded-xl hover:bg-blue-700 shadow-md transition duration-150"
                            disabled={isSaving}
                        >
                            {isSaving ? <Icon name="Loader" className="w-5 h-5 animate-spin" /> : <Icon name="Save" className="w-5 h-5" />}
                            <span>Guardar Ajustes</span>
                        </button>
                        
                        {saveMessage && (
                            <div className="mt-2 text-sm text-green-600 font-medium flex items-center">
                                <Icon name="CheckCircle" className="w-4 h-4 mr-1" /> {saveMessage}
                            </div>
                        )}
                        
                    </div>
                    
                    {/* Información del Usuario */}
                    <div className="bg-gray-100 p-6 rounded-2xl shadow-inner space-y-2 text-sm">
                        <h3 className="text-lg font-bold text-gray-800">Información del Sistema</h3>
                        <p className="text-gray-600">ID del Usuario: <code className="bg-gray-200 p-1 rounded-md text-xs">{userId || 'Cargando...'}</code></p>
                        <p className="text-gray-600">App ID: <code className="bg-gray-200 p-1 rounded-md text-xs">{window.appId}</code></p>
                        <p className="text-gray-600">Última Actualización de Datos: <code className="bg-gray-200 p-1 rounded-md text-xs">{data.lastUpdate ? new Date(data.lastUpdate).toLocaleString() : 'N/A'}</code></p>
                    </div>

                </div>
            );
        };

        // =========================================================================
        // COMPONENTE PRINCIPAL
        // =========================================================================

        const App = () => {
            const [currentTab, setCurrentTab] = useState(DEFAULT_TAB);

            const renderContent = () => {
                switch (currentTab) {
                    case 'overview':
                        return <Overview />;
                    case 'transactions':
                        return <Transactions />;
                    case 'goals':
                        return <Goals />;
                    case 'analysis':
                        return <Analysis />;
                    default:
                        return <Overview />;
                }
            };

            return (
                <AppProvider>
                    <div className="min-h-screen bg-gray-50 flex flex-col">
                        
                        {/* Header */}
                        <header className="bg-white shadow-lg p-4 sticky top-0 z-10">
                            <div className="max-w-6xl mx-auto flex flex-col sm:flex-row justify-between items-center space-y-4 sm:space-y-0">
                                <div className="flex items-center">
                                    <Icon name="Landmark" className="w-8 h-8 text-blue-600 mr-3" />
                                    <h1 className="text-2xl font-bold text-gray-900">Planificador Financiero</h1>
                                </div>
                                <Navigation currentTab={currentTab} setCurrentTab={setCurrentTab} />
                            </div>
                        </header>

                        {/* Main Content */}
                        <main className="flex-grow max-w-6xl mx-auto w-full">
                            {renderContent()}
                        </main>

                        {/* Footer (Opcional, si se necesita) */}
                        <footer className="w-full p-4 bg-gray-200 text-center text-sm text-gray-600 mt-8">
                            © 2024 Planificador Financiero. Propulsado por Firebase y React.
                        </footer>
                    </div>
                </AppProvider>
            );
        };

        // =========================================================================
        // INICIO DE LA APLICACIÓN (NO MODIFICAR)
        // =========================================================================

        // Usamos window.onload para asegurarnos de que el DOM y el script 'module' estén cargados)
        window.onload = function() {
            const rootElement = document.getElementById('root');
            
            // Verificamos que las funciones que expusimos en el script 'module' estén ahora disponibles
            // NOTA: initializeApp es una función importada en el script module, no globalmente expuesta.
            // La verificación correcta es si las funciones que *deberían* ser globales (como initializeFirebase) existen.
            if (typeof window.initializeFirebase === 'undefined') {
                rootElement.innerHTML = '<div class="flex items-center justify-center min-h-screen bg-gray-100 p-8"><div class="p-10 text-center text-xl text-red-700 bg-red-100 rounded-xl shadow-lg border-l-4 border-red-500">❌ Error Crítico: No se pudo cargar el SDK de Firebase o las funciones de inicialización.</div></div>';
                console.error("Error: Las funciones de Firebase no están disponibles. El script 'module' puede haber fallado o la carga fue muy lenta.");
                return;
            }

            try {
                // Montar la aplicación React
                const root = ReactDOM.createRoot(rootElement);
                root.render(<App />);

            } catch (e) {
                console.error("Error durante el montaje de React:", e);
                rootElement.innerHTML = '<div class="flex items-center justify-center min-h-screen bg-gray-100 p-8"><div class="p-10 text-center text-xl text-red-700 bg-red-100 rounded-xl shadow-lg border-l-4 border-red-500">❌ Error de Montaje de la Aplicación: ' + (e.message || 'Fallo al inicializar la aplicación.') + '</div></div>';
            }
        };
    </script>
</body>
</html>
